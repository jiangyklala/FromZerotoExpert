# FromZerotoExpert

## 注册:
### 用户名限制
+ 不能为空(前端)
+ 不能有空格
+ 不能有敏感词
+ 用户名唯一
### 密码限制
+ 不能为空(前端)
+ 长度
+ 强度(只能用三种字符中至少两种)
### 加密密码
+ 随机盐 + 真盐 + 双重MD5
## 登录
### 用户名限制
+ 不能为空(前端)
+ 是否不存在
    + 不符合"注册"时的限制
    + 未注册
### 密码限制
+ 不能为空(前端)
+ 错误
    + 不符合"注册"时的限制
    + 密码错误
### 自动登录
  1. **首次登录:** 登录时生成Cookie: fzteUser-sessionId, 同时在 redis 中以哈希存储用户信息: key: sessionId field:name value:userName
  2. **二次登录:** 登录时检测Cookie,
     + 若有, 若这次登录的账号和上次相同更新 Cooike 和 redis 中的键有效期；若不相同，删除上次的用户信息，创建新账号的信息
     + 如无, 进行1.
  3. **访问首页:** 根据是否有Cookie, 且 Cookie 中的 sessionId 在 redis 中是否过期(防止用户手动更改 Cookie 有效期)实现自动登录
### 不允许多个设备同时在线
将用户登录时的时间戳作为唯一登录凭证，一份作为 Cookie 【loginCert = 时间戳】放在用户的浏览器中，一份记录在redis中：【lc = 时间戳 】（loginCertifate）。

每次用户登录时都会更新这个唯一登录凭证，拦截器中拦截本地的登录凭证和 redis 记录的凭证不同的请求。如果同时有两用户登录，则后面用户的唯一登录凭证是最新的，前一个人只需在下一次操作时用拦截器中拦截即可。

**遇到的问题：**

+ 两个设备都需要在**本地**有一个：能通过其访问到该用户在redis中的信息的变量，于是就把这个变量从原来的雪花ID换成了用户登录的【账号】（当前我的程序还没有区分账号和昵称，后续慢慢改）
+ 在创建拦截器时，因为拦截器是在Spring Context 初始化之前执行，不能直接注入 Service 对象，但我的拦截判断需要它。虽然通过一些途径能达到我的需求，但这样是不是”走歪路“？
+ 在拦截器判断中我需要用到保存的Cookie，就会导致每次用户在请求时都需要重新查一遍所有Cookie直至找到我要用的Cookie，效率不高？
+ 有些地方的代码我自己都看着臃肿

### 允许 PC 和移动端同时在线
需要用到 request 中 key 为 user-agent 的值。思路：扩展”唯一登录用户凭证“，根据当前登录的电脑/手机设备，生成“唯一设备登录凭证”，在本地设置名为 ”PcLoginCert" 或 “MbLoginCert” 的 Cookie，同时也在 redis 用户哈希表中用 “plc” 或 “mlc” 保存对应凭证。拦截器拦截时，根据当前电脑/手机，检测 redis 中相应的凭证是否一致。

### 如何记录用户的在线状态和离线状态？

**想法1：** 用户登录时在redis中记录 online=1，用户登出时设置 online=0 。

问题1：如何准确记录用户的登出状态？

+ js中的 onbeforeunload, onunload 不能完全满足需求，`As of Chrome 60, the confirmation will be skipped if the user has not performed a gesture in the frame or page since it was loaded.`  即用户登录后必须在网页中做一些操作，否则不会执行那两个函数

**想法2：** 在用户端向服务器端发送“心跳信息“。

问题1：会导致服务器增加负载